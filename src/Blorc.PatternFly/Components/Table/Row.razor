@using System.Linq
@using Blorc.PatternFly.Components.Dropdown
@using Blorc.PatternFly.Components.Button
@using Blorc.PatternFly.Layouts.Split
@using Blorc.PatternFly.Helpers
@using Blorc.Reflection
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Web

@inherits RowComponent


    @if (ChildContent != null)
    {
        <tr class="@Class">
            @ChildContent
        </tr>
    }
    else if (ContainerTable != null && Record != null)
    {
        <tr class="@Class">
            @foreach (var columnDefinition in ContainerTable.ColumnDefinitions.OrderBy(pair => pair.Value.Idx).Select(pair => pair.Value))
            {
                if (columnDefinition is ActionColumnDefinition actionColumnDefinition)
                {
                    var actionDefinitions = actionColumnDefinition.ActionSource(Record)?.ToList();
                    <ActionCell>
                        @if (actionDefinitions != null)
                        {
                            @if (actionColumnDefinition.ActionColumnType == ActionColumnType.Toggle)
                            {
                                <Dropdown IsPlain="true" Position="@DropdownPosition.Right">
                                    <Toggle>
                                        <KebabToggle />
                                    </Toggle>
                                    <Items>
                                        @foreach (var action in actionDefinitions)
                                        {
                                            @if (action is SeparatorActionDefinition)
                                            {
                                                <Separator Key="separator" />
                                            }
                                            else if (action is CallActionDefinition callActionDefinition)
                                            {
                                                <DropdownItem Key="@callActionDefinition.Key" OnClick=@((s, e) => callActionDefinition.Action(Record)) IsDisabled="@callActionDefinition.IsDisabled">@callActionDefinition.Label</DropdownItem>
                                            }
                                        }
                                    </Items>
                                </Dropdown>
                            }
                            else if (actionColumnDefinition.ActionColumnType == ActionColumnType.ButtonAndToggle)
                            {
                                var actionDefinition = actionDefinitions.OfType<CallActionDefinition>().FirstOrDefault(definition => !definition.IsDisabled);
                                <Split IsGutter="true">
                                    @if (actionDefinition != null)
                                    {
                                        <SplitItem IsFilled="true">
                                            <Button Variant=@ButtonVariant.Primary OnClick=@((s, e) => actionDefinition.Action(Record)) IsDisabled="@actionDefinition.IsDisabled">@actionDefinition.Label</Button>
                                        </SplitItem>
                                    }
                                    <SplitItem >
                                        <Dropdown IsPlain="true" Position="@DropdownPosition.Right">
                                            <Toggle>
                                                <KebabToggle />
                                            </Toggle>
                                            <Items>
                                                @foreach (var action in actionDefinitions)
                                                {
                                                    @if (action is SeparatorActionDefinition)
                                                    {
                                                        <Separator Key="separator" />
                                                    }
                                                    else if (action is CallActionDefinition callActionDefinition)
                                                    {
                                                        <DropdownItem Key="@callActionDefinition.Key" OnClick=@((s, e) => callActionDefinition.Action(Record)) IsDisabled="@callActionDefinition.IsDisabled">@callActionDefinition.Label</DropdownItem>
                                                    }
                                                }
                                            </Items>
                                        </Dropdown>
                                    </SplitItem>
                                </Split>
                            }
                            else
                            {
                                int i = 0;
                                <Split IsGutter=@(actionColumnDefinition.ActionColumnType == ActionColumnType.GutterButtons)>
                                    @foreach (var action in actionDefinitions)
                                    {
                                        if (action is CallActionDefinition callActionDefinition)
                                        {
                                            var buttonVariant = ButtonVariants[Math.Min(ButtonVariants.Length - 1, i++)];
                                            <SplitItem IsFilled="true">
                                                <Button Variant=@buttonVariant OnClick=@((s, e) => callActionDefinition.Action(Record)) IsDisabled="@callActionDefinition.IsDisabled">@callActionDefinition.Label</Button>
                                            </SplitItem>
                                        }
                                    }
                                </Split>
                            }
                        }
                    </ActionCell>
                }
                else
                {
                    <Cell Label="@columnDefinition.Label" Key="@columnDefinition.Key" Value="@DataHelper.GetValue(Record, columnDefinition.Key)?.ToString()" />
                }
            }
         </tr>
    }